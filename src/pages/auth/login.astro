---
import Layout from "@/layouts/Layout.astro";
import { AuthLayout } from "@/components/auth/AuthLayout";
import { LoginForm } from "@/components/auth/LoginForm";
import { createSupabaseServerInstance } from "@/db/supabase.client";

export const prerender = false;

// Sprawdź czy użytkownik jest już zalogowany
const supabase = createSupabaseServerInstance({
  cookies: Astro.cookies,
  headers: new Headers(Astro.request.headers),
});
const {
  data: { user },
} = await supabase.auth.getUser();

// Jeśli użytkownik jest zalogowany, przekieruj go
if (user) {
  const returnUrl = Astro.url.searchParams.get("returnUrl") || "/";
  return Astro.redirect(returnUrl);
}

// Sprawdź, czy użytkownik przyszedł ze strony rejestracji
const message = Astro.url.searchParams.get("message");
---

<Layout title="Logowanie - 10xCards">
  <AuthLayout
    client:load
    title="Witaj z powrotem!"
    description={message === "verify-email"
      ? "Sprawdź swoją skrzynkę email, aby potwierdzić konto. Po potwierdzeniu możesz się zalogować."
      : "Zaloguj się do swojego konta"}
  >
    <LoginForm client:load />
  </AuthLayout>
</Layout>
